{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended"
  ],
  "enabledManagers": [
    "custom.regex",
    "gitlabci",
    "github-actions"
  ],
  "prHourlyLimit": 5,
  "prConcurrentLimit": 3,
  "rangeStrategy": "replace",
  "commitMessagePrefix": "chore(deps): ",
  "branchPrefix": "renovate/",
  "branchConcurrentLimit": 5,
  "semanticCommits": "enabled",
  "semanticCommitType": "chore",
  "semanticCommitScope": "deps",
  "customManagers": [
    {
      "customType": "regex",
      "description": "Update Flux GitOps Toolkit components",
      "fileMatch": [
        "^k8s/flux-system/gotk-components\\.yaml$"
      ],
      "matchStrings": [
        "image: ghcr\\.io/fluxcd/(?<depName>[^:]+):v?(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "datasourceTemplate": "docker",
      "registryUrlTemplate": "https://ghcr.io",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Flux version comments and sync manifests",
      "fileMatch": [
        "^k8s/flux-system/gotk-components\\.yaml$",
        "^k8s/flux-system/gotk-sync\\.yaml$"
      ],
      "matchStrings": [
        "# Flux Version: v(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+)"
      ],
      "depNameTemplate": "flux2",
      "datasourceTemplate": "github-releases",
      "packageNameTemplate": "fluxcd/flux2",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update Kustomization targetRevision/tag for Flux",
      "fileMatch": [
        "^k8s/flux-system/.*\\.yaml$"
      ],
      "matchStrings": [
        "apiVersion: kustomize\\.toolkit\\.fluxcd\\.io/v1[\\s\\S]*?kind: Kustomization[\\s\\S]*?ref:[\\s\\S]*?tag: [\"']?v?(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+)[\"']?[\\s\\S]*?url: [\"']?https://github\\.com/fluxcd/flux2[\"']?"
      ],
      "depNameTemplate": "flux2",
      "datasourceTemplate": "github-tags",
      "packageNameTemplate": "fluxcd/flux2",
      "versioningTemplate": "semver"
    },
    {
      "customType": "regex",
      "description": "Update GitRepository ref for Flux",
      "fileMatch": [
        "^k8s/flux-system/.*\\.yaml$"
      ],
      "matchStrings": [
        "apiVersion: source\\.toolkit\\.fluxcd\\.io/v1[\\s\\S]*?kind: GitRepository[\\s\\S]*?ref:[\\s\\S]*?tag: [\"']?v?(?<currentValue>[0-9]+\\.[0-9]+\\.[0-9]+)[\"']?[\\s\\S]*?url: [\"']?https://github\\.com/fluxcd/flux2[\"']?"
      ],
      "depNameTemplate": "flux2",
      "datasourceTemplate": "github-tags",
      "packageNameTemplate": "fluxcd/flux2",
      "versioningTemplate": "semver"
    }
  ],
  "hostRules": [
    {
      "matchHost": "ghcr.io",
      "hostType": "docker"
    }
  ],
  "packageRules": [
    {
      "description": "Flux system components - auto-merge minor and patch updates",
      "matchDatasources": ["docker", "github-releases", "github-tags"],
      "matchPackagePatterns": [
        "^ghcr\\.io/fluxcd/",
        "^fluxcd/"
      ],
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true,
      "automergeType": "pr",
      "platformAutomerge": true
    },
    {
      "description": "Flux system components - manual review for major updates",
      "matchDatasources": ["docker", "github-releases", "github-tags"],
      "matchPackagePatterns": [
        "^ghcr\\.io/fluxcd/",
        "^fluxcd/"
      ],
      "matchUpdateTypes": ["major"],
      "automerge": false,
      "prPriority": 10
    },
    {
      "description": "Group Flux updates together",
      "matchDatasources": ["docker", "github-releases", "github-tags"],
      "matchPackagePatterns": [
        "^ghcr\\.io/fluxcd/",
        "^fluxcd/"
      ],
      "groupName": "flux-system",
      "groupSlug": "flux-system"
    }
  ],
  "labels": ["dependencies", "renovate", "flux"],
  "timezone": "UTC",
  "schedule": [
    "at any time"
  ],
  "vulnerabilityAlerts": {
    "enabled": true
  },
  "lockFileMaintenance": {
    "enabled": false
  },
  "ignorePaths": [
    "**/node_modules/**",
    "**/vendor/**",
    "**/.git/**"
  ],
  "prBodyTemplate": "This PR updates Flux components.\n\n### ⚠️ Important Notes for Flux Updates:\n\n1. **Review the [Flux Release Notes](https://github.com/fluxcd/flux2/releases)** for breaking changes\n2. **Verify CRD updates** - Check if new CRDs need to be applied manually\n3. **Test in non-production first** if this is a major version update\n4. **Check compatibility** with your current Kubernetes version\n\n### Files Updated:\n{{#each upgrades}}\n- `{{packageFile}}`: {{depName}} `{{currentValue}}` → `{{newValue}}`\n{{/each}}\n\n### How to apply:\n```bash\n# Apply the changes to your cluster\nkubectl apply -f k8s/flux-system/\n\n# Verify all components are running\nflux check\n```"
}
